# 坚持有你 - 数据库设计文档

## 📋 项目概述

**项目名称**: 坚持有你 - 健康管理小程序  
**数据库类型**: MySQL 8.0+  
**ORM框架**: Prisma  
**设计版本**: v1.0  
**创建日期**: 2024-12-19

## 🏗️ 数据库架构概览

### 核心业务模块

- **用户管理系统** - 微信授权登录、个人档案、情侣绑定
- **168断食管理** - 断食计划、计时追踪、历史记录
- **体重管理** - 体重记录、趋势分析、BMI计算
- **成就系统** - 徽章解锁、里程碑记录、积分奖励
- **情侣互动** - 数据同步、相互鼓励、共同目标
- **消息推送** - 智能提醒、微信通知、状态同步
- **饮食记录** - 进餐时间、饮食分析、心情记录
- **系统配置** - 动态配置、参数管理

## 📊 数据库关系图 (ER Diagram)

![image-20250627144455928](/Users/Jiazhigang/Library/Application Support/typora-user-images/image-20250627144455928.png)

### 1. 核心关系结构

#### 1.1 用户中心关系

- `users` → `fasting_plans` (一对多) - 用户可以创建多个断食计划
- `users` → `fasting_records` (一对多) - 用户每天可以有一条断食记录
- `users` → `weight_records` (一对多) - 用户每天可以有一条体重记录
- `users` → `user_achievements` (一对多) - 用户可以获得多个成就
- `users` → `food_records` (一对多) - 用户可以记录多条饮食信息
- `users` → `notifications` (一对多) - 用户可以接收多条通知

#### 1.2 情侣互动关系

- `users` ↔ `users` 通过 `couple_relations` (多对多) - 用户之间的情侣关系
- `users` → `encouragements` (一对多，发送/接收) - 用户之间的鼓励消息

#### 1.3 断食管理关系

- `fasting_plans` → `fasting_records` (一对多) - 一个计划可以生成多条记录
- 用户每天只能有一条断食记录 (unique约束)

#### 1.4 成就系统关系

- `achievement_definitions` → `user_achievements` (一对多) - 成就定义与用户成就的关系
- 用户与成就定义之间是多对多关系，通过 `user_achievements` 表关联

## 📋 表结构详细说明

### 1. 用户表 (users)

**用途**: 存储用户基础信息和档案数据

**核心字段说明**:

- `open_id`: 微信OpenID，用户唯一标识
- `invite_code`: 用户邀请码，用于情侣绑定
- `couple_id`: 情侣关系ID，关联情侣用户
- `target_weight/current_weight`: 目标体重与当前体重

**业务约束**:

- `open_id` 全局唯一
- `invite_code` 全局唯一
- 体重数据保留2位小数

### 2. 断食计划表 (fasting_plans)

**用途**: 存储用户的168断食计划配置

**核心字段说明**:

- `fasting_hours/eating_hours`: 禁食和进食小时数
- `start_time/end_time`: 进食窗口的开始和结束时间
- `is_active`: 是否为当前激活的计划

**业务约束**:

- 用户可以有多个计划，但只能有一个激活计划
- 时间字段存储为TIME类型

### 3. 断食记录表 (fasting_records)

**用途**: 记录用户每日的断食执行情况

**核心字段说明**:

- `actual_hours`: 实际完成的断食小时数
- `status`: 断食状态 (active/completed/broken)
- `mood_before/mood_after`: 断食前后的心情状态

**业务约束**:

- 每个用户每天只能有一条记录
- 支持中断原因记录

### 4. 体重记录表 (weight_records)

**用途**: 记录用户的体重变化数据

**核心字段说明**:

- `weight`: 体重数据，精确到0.01kg
- `bmi/body_fat_rate/muscle_mass`: 身体数据指标
- `photo_before/photo_after`: 对比照片

**业务约束**:

- 每个用户每天只能有一条记录
- 支持照片对比功能

### 5. 成就系统表

#### 5.1 成就定义表 (achievement_definitions)

**用途**: 定义系统中所有可获得的成就

**核心字段说明**:

- `code`: 成就唯一标识码
- `rule_config`: JSON格式的成就规则配置
- `rarity`: 成就稀有度 (common/rare/epic/legendary)

#### 5.2 用户成就表 (user_achievements)

**用途**: 记录用户获得成就的进度和状态

**核心字段说明**:

- `progress/target`: 当前进度和目标值
- `is_unlocked`: 是否已解锁
- `unlocked_at`: 解锁时间

### 6. 情侣关系表 (couple_relations)

**用途**: 管理用户之间的情侣关系

**核心字段说明**:

- `user1_id/user2_id`: 情侣双方的用户ID
- `status`: 关系状态 (pending/active/inactive)
- `invited_by`: 发起邀请的用户ID

**业务约束**:

- 两个用户之间只能有一条关系记录
- 支持邀请-确认机制

### 7. 鼓励消息表 (encouragements)

**用途**: 存储情侣之间的相互鼓励消息

**核心字段说明**:

- `sender_id/receiver_id`: 发送者和接收者ID
- `type`: 消息类型 (text/emoji/achievement)
- `is_read`: 是否已读状态

### 8. 推送通知表 (notifications)

**用途**: 管理系统推送通知记录

**核心字段说明**:

- `type`: 通知类型 (断食提醒/成就解锁/情侣鼓励等)
- `template_id`: 微信模板消息ID
- `push_data`: 推送数据的JSON配置

### 9. 饮食记录表 (food_records)

**用途**: 记录用户的饮食信息

**核心字段说明**:

- `meal_type`: 餐次类型 (breakfast/lunch/dinner/snack)
- `food_items`: JSON格式的食物清单
- `satiety_rating`: 饱腹感评分 (1-5星)

### 10. 系统配置表 (system_configs)

**用途**: 存储系统动态配置参数

**核心字段说明**:

- `key`: 配置键，全局唯一
- `type`: 数据类型 (string/number/boolean/json)
- `is_public`: 是否为公开配置

## 🚀 索引设计策略

### 1. 主要索引

#### 高频查询索引

```sql
-- 用户日期范围查询
KEY `idx_date_range` (`user_id`, `date`)

-- 用户状态查询
KEY `idx_active` (`user_id`, `is_active`)

-- 时间排序查询
KEY `idx_created_at` (`created_at`)
```

#### 唯一约束索引

```sql
-- 防止重复数据
UNIQUE KEY `uk_user_date` (`user_id`, `date`)
UNIQUE KEY `uk_open_id` (`open_id`)
UNIQUE KEY `uk_invite_code` (`invite_code`)
```

#### 外键关系索引

```sql
-- 关联查询优化
KEY `idx_user_id` (`user_id`)
KEY `idx_plan_id` (`plan_id`)
KEY `idx_achievement_id` (`achievement_id`)
```

### 2. 复合索引策略

- **查询模式分析**: 根据业务查询模式设计复合索引
- **选择性原则**: 高选择性字段放在索引前面
- **覆盖索引**: 尽可能使用覆盖索引减少回表查询

## 📊 数据类型说明

### 1. 精度控制

- **体重数据**: `DECIMAL(5,2)` - 支持999.99kg，精确到0.01
- **BMI数据**: `DECIMAL(4,2)` - 支持99.99，精确到0.01
- **断食时长**: `DECIMAL(4,2)` - 支持99.99小时，精确到0.01

### 2. 枚举类型

- **状态枚举**: 使用MySQL ENUM类型存储固定状态值
- **类型安全**: Prisma自动生成TypeScript枚举类型
- **扩展性**: 预留枚举值便于后续扩展

### 3. JSON数据

- **配置存储**: 使用JSON字段存储灵活配置
- **规则引擎**: 成就规则配置支持复杂逻辑
- **推送数据**: 微信推送的动态数据配置

## 🔐 数据安全设计

### 1. 外键约束

- **级联删除**: 用户删除时自动清理相关数据
- **引用完整性**: 确保数据关系的一致性
- **孤儿数据防护**: 避免产生无效的关联数据

### 2. 数据验证

- **字段长度限制**: 防止超长数据攻击
- **数据类型约束**: 确保数据格式正确
- **业务规则验证**: 在应用层实现复杂业务规则

### 3. 隐私保护

- **敏感数据**: 用户隐私数据加密存储
- **访问控制**: 严格的数据访问权限控制
- **数据脱敏**: 日志和错误信息中的敏感数据脱敏

## 📈 性能优化建议

### 1. 查询优化

- **分页查询**: 使用LIMIT和OFFSET进行数据分页
- **索引优化**: 根据查询模式调整索引策略
- **查询缓存**: 使用Redis缓存热点数据

### 2. 存储优化

- **数据归档**: 定期归档历史数据
- **分区策略**: 对大表考虑按时间分区
- **存储引擎**: 使用InnoDB引擎支持事务

### 3. 连接优化

- **连接池**: 配置合适的数据库连接池
- **长连接**: 使用长连接减少连接开销
- **读写分离**: 考虑主从复制和读写分离

## 🛠️ 数据库操作命令

### 1. Prisma迁移

```bash
# 生成迁移文件
pnpm prisma migrate dev --name "init-health-management-schema"

# 生成客户端
pnpm prisma generate

# 推送到数据库
pnpm prisma db push

# 重置数据库
pnpm prisma migrate reset
```

### 2. 数据填充

```bash
# 执行种子数据
pnpm prisma db seed

# 查看数据库
pnpm prisma studio
```

### 3. 数据库维护

```bash
# 检查数据库状态
pnpm prisma migrate status

# 部署到生产环境
pnpm prisma migrate deploy
```

## 📝 版本历史

| 版本 | 日期       | 更新内容                             | 作者     |
| ---- | ---------- | ------------------------------------ | -------- |
| v1.0 | 2024-12-19 | 初始数据库设计，包含所有核心功能模块 | 开发团队 |

## 📋 待优化事项

### 短期优化

- [ ] 添加数据库性能监控
- [ ] 优化复杂查询的索引策略
- [ ] 实现数据备份和恢复机制

### 长期优化

- [ ] 考虑数据分片策略
- [ ] 评估NoSQL数据库的使用场景
- [ ] 实现数据湖和数据仓库

---

_文档版本: v1.0_  
_创建时间: 2024-12-19_  
_更新时间: 2024-12-19_
