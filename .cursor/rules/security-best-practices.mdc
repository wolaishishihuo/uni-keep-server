---
description:
globs:
alwaysApply: true
---
# å®‰å…¨å¼€å‘æœ€ä½³å®è·µ

## ğŸ” è®¤è¯ä¸æˆæƒå®‰å…¨

### JWT å®‰å…¨é…ç½®
å‚è€ƒ [src/common/constants.ts](mdc:src/common/constants.ts) å’Œ [src/auth](mdc:src/auth)ï¼š

#### JWT å¯†é’¥ç®¡ç†
```typescript
// âŒ é”™è¯¯ï¼šç¡¬ç¼–ç å¯†é’¥
export const jwtConstants = {
  secret: 'secretKey', // ä¸å®‰å…¨
};

// âœ… æ­£ç¡®ï¼šç¯å¢ƒå˜é‡
export const jwtConstants = {
  secret: process.env.JWT_SECRET, // ä»ç¯å¢ƒå˜é‡è¯»å–
  expiresIn: process.env.JWT_EXPIRES_IN || '1h',
  refreshExpiresIn: process.env.JWT_REFRESH_EXPIRES_IN || '7d',
};
```

#### å¯†ç å®‰å…¨å¤„ç†
```typescript
import * as bcrypt from 'bcrypt';

@Injectable()
export class AuthService {
  // å¯†ç åŠ å¯†
  async hashPassword(password: string): Promise<string> {
    const saltRounds = 12; // ä½¿ç”¨è¶³å¤Ÿçš„ç›è½®æ•°
    return bcrypt.hash(password, saltRounds);
  }

  // å¯†ç éªŒè¯
  async validatePassword(password: string, hash: string): Promise<boolean> {
    return bcrypt.compare(password, hash);
  }

  // å¯†ç å¼ºåº¦éªŒè¯
  validatePasswordStrength(password: string): boolean {
    const minLength = 8;
    const hasUpperCase = /[A-Z]/.test(password);
    const hasLowerCase = /[a-z]/.test(password);
    const hasNumbers = /\d/.test(password);
    const hasSpecialChar = /[!@#$%^&*(),.?":{}|<>]/.test(password);

    return (
      password.length >= minLength &&
      hasUpperCase &&
      hasLowerCase &&
      hasNumbers &&
      hasSpecialChar
    );
  }
}
```

### è®¤è¯å®ˆå«å¢å¼º
å‚è€ƒ [src/common/guards](mdc:src/common/guards)ï¼š

```typescript
@Injectable()
export class JwtAuthGuard extends AuthGuard('jwt') {
  canActivate(context: ExecutionContext) {
    const request = context.switchToHttp().getRequest();

    // IPç™½åå•æ£€æŸ¥ï¼ˆç®¡ç†å‘˜æ¥å£ï¼‰
    if (this.isAdminRoute(request.url)) {
      const clientIp = this.getClientIp(request);
      if (!this.isAllowedIp(clientIp)) {
        throw new ForbiddenException('IP not allowed');
      }
    }

    return super.canActivate(context);
  }

  private getClientIp(request: any): string {
    return request.headers['x-forwarded-for'] ||
           request.connection.remoteAddress ||
           request.socket.remoteAddress;
  }
}
```

## ğŸ›¡ï¸ è¾“å…¥éªŒè¯ä¸æ•°æ®å®‰å…¨

### ä¸¥æ ¼çš„æ•°æ®éªŒè¯
```typescript
import { IsEmail, IsString, MinLength, MaxLength, Matches } from 'class-validator';

export class CreateUserDto {
  @IsEmail({}, { message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€' })
  email: string;

  @IsString()
  @MinLength(8, { message: 'å¯†ç è‡³å°‘8ä½' })
  @MaxLength(20, { message: 'å¯†ç æœ€å¤š20ä½' })
  @Matches(
    /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]/,
    { message: 'å¯†ç å¿…é¡»åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦' }
  )
  password: string;

  @IsString()
  @MinLength(2, { message: 'ç”¨æˆ·åè‡³å°‘2ä½' })
  @MaxLength(20, { message: 'ç”¨æˆ·åæœ€å¤š20ä½' })
  @Matches(/^[a-zA-Z0-9_\u4e00-\u9fa5]+$/, { message: 'ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œä¸­æ–‡' })
  username: string;
}
```

### SQL æ³¨å…¥é˜²æŠ¤
```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ Prisma çš„ç±»å‹å®‰å…¨æŸ¥è¯¢
async findUsersByName(name: string) {
  const prisma = this.globalService.getPrisma();
  return prisma.user.findMany({
    where: {
      name: {
        contains: name, // Prisma è‡ªåŠ¨å¤„ç† SQL æ³¨å…¥é˜²æŠ¤
      },
    },
  });
}

// âŒ é”™è¯¯ï¼šåŸç”Ÿ SQL æ‹¼æ¥
async findUsersByNameUnsafe(name: string) {
  const query = `SELECT * FROM users WHERE name LIKE '%${name}%'`; // å±é™©
  return this.database.query(query);
}
```

### XSS é˜²æŠ¤
```typescript
import { Transform } from 'class-transformer';
import { sanitize } from 'class-sanitizer';

export class CreatePostDto {
  @IsString()
  @Transform(({ value }) => sanitize(value)) // è‡ªåŠ¨æ¸…ç† HTML
  title: string;

  @IsString()
  @Transform(({ value }) => this.sanitizeHtml(value))
  content: string;

  private sanitizeHtml(html: string): string {
    // ä½¿ç”¨ DOMPurify æˆ–ç±»ä¼¼åº“æ¸…ç† HTML
    return html.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
  }
}
```

## ğŸ”’ æ•°æ®åº“å®‰å…¨

### æ•æ„Ÿæ•°æ®åŠ å¯†
```typescript
import * as crypto from 'crypto';

@Injectable()
export class EncryptionService {
  private readonly algorithm = 'aes-256-gcm';
  private readonly secretKey = process.env.ENCRYPTION_KEY;

  encrypt(text: string): { encrypted: string; iv: string; tag: string } {
    const iv = crypto.randomBytes(16);
    const cipher = crypto.createCipher(this.algorithm, this.secretKey);
    cipher.setAAD(Buffer.from('uni-keep'));

    let encrypted = cipher.update(text, 'utf8', 'hex');
    encrypted += cipher.final('hex');

    const tag = cipher.getAuthTag();

    return {
      encrypted,
      iv: iv.toString('hex'),
      tag: tag.toString('hex'),
    };
  }

  decrypt(encryptedData: { encrypted: string; iv: string; tag: string }): string {
    const decipher = crypto.createDecipher(this.algorithm, this.secretKey);
    decipher.setAAD(Buffer.from('uni-keep'));
    decipher.setAuthTag(Buffer.from(encryptedData.tag, 'hex'));

    let decrypted = decipher.update(encryptedData.encrypted, 'hex', 'utf8');
    decrypted += decipher.final('utf8');

    return decrypted;
  }
}
```

### æ•°æ®åº“è¿æ¥å®‰å…¨
```typescript
// ç¯å¢ƒå˜é‡é…ç½®ç¤ºä¾‹
DATABASE_URL="mysql://username:password@localhost:3306/database?sslmode=require"
REDIS_PASSWORD="strong_redis_password"
MONGODB_AUTH_SOURCE="admin"
```

## ğŸŒ ç½‘ç»œå®‰å…¨

### CORS é…ç½®
```typescript
// main.ts
app.enableCors({
  origin: process.env.ALLOWED_ORIGINS?.split(',') || ['http://localhost:3000'],
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH'],
  allowedHeaders: ['Content-Type', 'Authorization'],
});
```

### è¯·æ±‚é™æµ
```typescript
import { ThrottlerGuard, ThrottlerModule } from '@nestjs/throttler';

// æ¨¡å—é…ç½®
ThrottlerModule.forRoot({
  ttl: 60, // 60ç§’çª—å£
  limit: 100, // æœ€å¤š100ä¸ªè¯·æ±‚
})

// ä½¿ç”¨å®ˆå«
@UseGuards(ThrottlerGuard)
@Controller('auth')
export class AuthController {
  @Throttle(5, 60) // ç™»å½•æ¥å£æ›´ä¸¥æ ¼ï¼š60ç§’å†…æœ€å¤š5æ¬¡
  @Post('login')
  async login() {}
}
```

### è¯·æ±‚å¤§å°é™åˆ¶
```typescript
// main.ts
app.use(express.json({ limit: '1mb' }));
app.use(express.urlencoded({ limit: '1mb', extended: true }));
```

## ğŸ“ æ–‡ä»¶ä¸Šä¼ å®‰å…¨

### æ–‡ä»¶ç±»å‹éªŒè¯
```typescript
import { Express } from 'express';
import { FileInterceptor } from '@nestjs/platform-express';

@Controller('upload')
export class UploadController {
  @Post('image')
  @UseInterceptors(FileInterceptor('file', {
    fileFilter: (req, file, callback) => {
      if (!file.mimetype.match(/\/(jpg|jpeg|png|gif)$/)) {
        return callback(new Error('åªå…è®¸ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶'), false);
      }
      callback(null, true);
    },
    limits: {
      fileSize: 5 * 1024 * 1024, // 5MB é™åˆ¶
    },
  }))
  uploadImage(@UploadedFile() file: Express.Multer.File) {
    // æ–‡ä»¶å¤„ç†é€»è¾‘
  }
}
```

## ğŸ” å®‰å…¨æ—¥å¿—ä¸ç›‘æ§

### å®‰å…¨äº‹ä»¶è®°å½•
å‚è€ƒ [src/common/configs/logger.config.ts](mdc:src/common/configs/logger.config.ts)ï¼š

```typescript
@Injectable()
export class SecurityService {
  private readonly logger = new Logger(SecurityService.name);

  logSecurityEvent(event: string, details: any, request: any) {
    const securityLog = {
      event,
      timestamp: new Date().toISOString(),
      ip: this.getClientIp(request),
      userAgent: request.headers['user-agent'],
      userId: request.user?.id,
      details,
    };

    this.logger.warn(`Security Event: ${JSON.stringify(securityLog)}`);
  }

  logFailedLogin(email: string, ip: string) {
    this.logSecurityEvent('FAILED_LOGIN', { email }, {
      headers: { 'x-forwarded-for': ip }
    });
  }

  logSuspiciousActivity(activity: string, userId: string, ip: string) {
    this.logSecurityEvent('SUSPICIOUS_ACTIVITY', { activity, userId }, {
      headers: { 'x-forwarded-for': ip }
    });
  }
}
```

## ğŸ”§ ç¯å¢ƒå˜é‡å®‰å…¨

### æ•æ„Ÿé…ç½®ç®¡ç†
```env
# .env æ–‡ä»¶ç¤ºä¾‹ï¼ˆä¸è¦æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ï¼‰
DATABASE_URL="mysql://user:pass@localhost:3306/db"
JWT_SECRET="your-super-secure-jwt-secret-minimum-32-characters"
ENCRYPTION_KEY="your-encryption-key-for-sensitive-data"
REDIS_PASSWORD="your-redis-password"

# ç¬¬ä¸‰æ–¹æœåŠ¡å¯†é’¥
SMTP_PASSWORD="email-service-password"
AWS_SECRET_ACCESS_KEY="aws-secret"
```

### é…ç½®éªŒè¯
```typescript
import { IsString, MinLength } from 'class-validator';

export class SecurityConfig {
  @IsString()
  @MinLength(32, { message: 'JWTå¯†é’¥è‡³å°‘32ä½' })
  jwtSecret: string;

  @IsString()
  @MinLength(16, { message: 'åŠ å¯†å¯†é’¥è‡³å°‘16ä½' })
  encryptionKey: string;
}
```

## ğŸ“‹ å®‰å…¨å¼€å‘æ£€æŸ¥æ¸…å•

### è®¤è¯æˆæƒæ£€æŸ¥
- [ ] JWTå¯†é’¥ä½¿ç”¨ç¯å¢ƒå˜é‡
- [ ] å¯†ç ä½¿ç”¨å¼ºåŠ å¯†ç®—æ³•
- [ ] å®ç°å¯†ç å¼ºåº¦éªŒè¯
- [ ] æ·»åŠ è®¤è¯å®ˆå«ä¿æŠ¤
- [ ] å®ç°è§’è‰²æƒé™æ§åˆ¶

### æ•°æ®éªŒè¯æ£€æŸ¥
- [ ] æ‰€æœ‰è¾“å…¥æ•°æ®ä¸¥æ ¼éªŒè¯
- [ ] é˜²æ­¢SQLæ³¨å…¥æ”»å‡»
- [ ] é˜²æ­¢XSSæ”»å‡»
- [ ] æ–‡ä»¶ä¸Šä¼ ç±»å‹é™åˆ¶
- [ ] è¯·æ±‚å¤§å°é™åˆ¶

### ç½‘ç»œå®‰å…¨æ£€æŸ¥
- [ ] CORSæ­£ç¡®é…ç½®
- [ ] å®ç°è¯·æ±‚é™æµ
- [ ] HTTPSå¼ºåˆ¶ä½¿ç”¨
- [ ] å®‰å…¨å¤´éƒ¨è®¾ç½®
- [ ] IPç™½åå•ï¼ˆå¦‚éœ€è¦ï¼‰

### ç›‘æ§å®¡è®¡æ£€æŸ¥
- [ ] è®°å½•å®‰å…¨äº‹ä»¶æ—¥å¿—
- [ ] ç›‘æ§å¼‚å¸¸è®¿é—®
- [ ] æ•æ„Ÿæ“ä½œå®¡è®¡
- [ ] é”™è¯¯ä¿¡æ¯è„±æ•
- [ ] å®šæœŸå®‰å…¨æ‰«æ
